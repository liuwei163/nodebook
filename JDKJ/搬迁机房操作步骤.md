以下是针对华大搬迁机房的总结, 对以后我们搬迁机房提供一些参考

先跟客户要配置信息
* 管理网的网段
* 存储外网的网段(包括实 IP 和 虚 IP)
* IPMI 地址（如果需要配置的话)
* ntp server
* dns 用法（一级还是二级），dns 域名的名字
* 需要访问 web ? 怎么访问?
通过管理网络? 要不要配置静态路由?

### 配置管理网络
先配置好管理网络，这样我们才能用管理网，来通过一台机器，连接其他节点配置
使用显示器先直连机器，进行管理网络的配置，最后笔记本连上管理网的交换机，就可以进行配置了
管理网只可能千兆的，千兆的网络只有 IPMI 或者管理网

配置好管理 IP 之后, 我们还要更改两个配置:
1. 更改每个存储节点的 `/etc/xt/mgmt.conf`这个配置文件, 把 IP 改成当前的 IP
2. 更改 etcd 上每个 pair 里的 mip 配置

### 确保内网和外网硬件连接正常
如果机器上的网口没有内外网的标签，我们需要:
* 首先确认外网的网卡和内网的网卡分别是哪个
* 确保内网的网线接的是内网的网口, 外网的网线接的是外网的网口
内网和外网通常会做 bond，两个网卡插的是光纤线，有光模块

光模块如果有问题，可能会出现的情况：
* 网卡识别不到，ethtool 或者 bond 信息里，能看到网卡没有连接，或者是 down 状态
* 如果是 bond4，正常情况下，ethtool bond，speed 会是两个网卡的总和，比如 20000Mb/s，如果光模块有问题，就会出现 speed 只是一个网卡的情况

插好光纤线之后，应该重启一下机器，这样网络才会重新 load，bond 才会协商好

### 更改外网网络 IP
硬件都准备之后，开始软件的配置，首先配置 IP，一般只会更改外网的网络，
1. 首先 ping 一下新网络的网关
确保可以 ping 通, 再走下一步, ping 不通就需要确认交换机或者是硬件是不是有问题
2. 使用下面的命令更改 ip 和网关
```sh
nmcli con mod bond-external ipv4.addresses 192.168.56.80/24
nmcli con mod bond-external ipv4.gateway 192.168.56.247
```
更改完成之后，出现一个奇怪的问题，`ip route`查看，我们的旧  route 竟然还在, 这是因为 ip route 自己有一个 cache, 我们需要执行:
```sh
ip route flush 10.61.52.0/24 
# 10.61.52.0/24 是我们要清掉的 route
```
才能清掉旧的 route
还有问题是, 我们执行`route`命令的时候, 这个命令会很长时间才返回, 这个原因是因为, `route`命令在执行的时候会查看 `/etc/resolv.conf`文件, 我们的 `/etc/resolve.conf`里保存的 nameserver 一般会是我们存储外网的实 IP, 我们需要更改 `/etc/resolve.conf`, 改成我们现在的存储外网实 IP, `route`才能正常快速的返回.

### 更改 ipzone 和 DNS
接下来我们需要把新分配的虚 IP 加到 ipzone 里去, 首先使用 ipzone 命令将原来的旧 IP 移除:
```sh
alamocli ipzone remove zone1 -device bond-external -addr 10.47.2.1 -device bond-external -addr 10.47.2.2 -device bond-external -addr 10.47.2.3 -device bond-external -addr 10.47.2.4
```
然后再把新的 IP 加上去
```
alamocli ipzone add zone1 -device bond-external -addr 192.168.56.84 -device bond-external -addr 192.168.56.85 -device bond-external -addr 192.168.56.86 -device bond-external -addr 192.168.56.87
```

加完之后, 使用 `alamocli ipzone status zone1`, 确保每个节点都分配到了 IP, ipzone 的配置更改就完成了.
ipzone 设置完成之后, 就可以更改了 DNS 了, 首先我们使用 `alamocli dns ls`, 查看一下之前的 dns 配置, 如果客户要求的 dns 跟之前的配置不一样的, 那么首先我们要删掉之前的配置:
```sh
alamocli dns rm alamotest 10.47.2.1 10.47.2.2 10.47.2.3 10.47.2.4
```
将所有的 IP 删掉之后, 整个 second domain 也就自动删掉了, 然后我们可以根据客户的要求, 重新加上新的 second domain:
```sh
alamocli dns add stomics 192.168.56.84 192.168.56.85 192.168.56.86 192.168.56.87
```

 dns 配置好之后, 我们需要根据客户的需求, 来指导他们进行 dns 的配置, 如果我们的 dns server 是作为一级来使用, 我们要:
1. 确保 dns 的策略是`rr-affinity`的, 可以通过 alamocli dns ls 看到
2.  我们得告诉客户, 需要在他们的节点上加上第一台节点的存储外网的实 IP, 作为 nameserver, 也就是说在客户机器的 `/etc/resolv.conf`里加上:
```
nameserver 192.168.56.80
```

如果是作为二级, 我们需要更改一下 dns 的策略:
```
alamocli dns netstrategy stomics 2
```

### 访问 alamo web
客户的计算节点如果想要访问 web, 我们当然可以通过存储外网来做, 但是存储外网一般是给生产 IO 来使用, 不建议作为访问 web 管理的 IP 来用, 这个时候可以通过管理 IP 来访问 web, 但是管理 IP 有一个问题是, 存储节点上一般有一个默认网关, 通常是存储外网的网关, 这个时候如果客户机器的 IP 能连到我们的管理网络, 但是我们的管理网络因为走了默认网关, 往往连不上客户的机器, 所以这里就要给管理网络的网卡上配置一个静态路由, 比如客户的网段是 `10.50.10.120/23`, 管理网的网关是, `192.168.200.1/24`, 那么我们通过:
```
nmcli con mod eno1 +ipv4.routes "10.50.10.120/23 192.168.200.1/24"
```
这句话的意思就是, 我们要通过 `192.168.200.1/24`这个网关, 来访问 `10.50.10.120/23`这个网段. 

### ntp server 配置
如果有更改 ntp server 的需要, 我们需要
1. 停掉每一台节点的 ntpd 服务, `systemctl stop ntpd`
2. 让每一台节点跟新的 ntp server 保持同步
在每一台节点上执行`ntpdate <new_ntp_server>`
3. 更改第一台节点的`/etc/chrony/ntp.conf`这个配置文件, 去掉旧的 ntp server, 加上新的 ntp server
4. 重新启动每一台节点的 ntpd 服务, `systemcdtl start ntpd`


